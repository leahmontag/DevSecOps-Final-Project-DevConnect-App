pipeline {
    agent any

    triggers {
        pollSCM('*/1 * * * *')
    }

    stages {
        stage('Delete Workspace Before Build Starts') {
            steps {
                script {
                    deleteDir()
                }
            }
        }

        stage('SCM Checkout') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/main']],
                          userRemoteConfigs: [[url: 'git@github.com:leahmontag/DevSecOps-Final-Project-DevConnect.git',
                                              credentialsId: 'private-key']]])
            }
        }

        stage('Build') {
            steps {
                script {
                    echo 'Building the application...'
                    docker build -t img_devConnect .
                    sh 'docker run -d -p 8000:8000 --name container_devConnect img_devConnect'
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    echo 'Running Django tests...'
                    sh 'python django_web_app/manage.py test'
                    def responseCode = sh(script: 'curl -s -o /dev/null -w "%{http_code}" http://your-app-url', returnStatus: true).trim()

                    if (responseCode == '200') {
                        echo 'Application is accessible with a 200(OK) response.'
                    } else {
                        error 'Failed to get a 200(OK) response. Pipeline will be marked as failed.'
                    }
                }
            }
        }

        // New deployment stage
        stage('Deploy') {
            steps {
                script {
                    echo 'Deploying the application...'
                    // Add your deployment commands here
                  //  # Example: kubectl apply -f deployment.yaml
                }
            }
        }
    }

    post {
        always {
            echo 'Cleaning up resources and workspace...'
            deleteDir()
        }
        failure {
            echo 'The pipeline failed :('
        }
    }
}
